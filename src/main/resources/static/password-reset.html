<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Restablecer contraseña | Alemandan POS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Incluye los CSS externos -->
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/reset_password.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
<!-- Header profesional -->
<header class="header">
    <nav class="navbar">
        <div class="logo-container">
            <a href="/">
                <img src="/assets/img/Alogo.png" alt="Alemandan Logo" class="logo bounce-in">
            </a>
        </div>
        <ul class="nav-links">
            <li><a href="/" class="nav-link">Inicio</a></li>
            <li><a href="/#features" class="nav-link">Características</a></li>
            <li><a href="/#about" class="nav-link">Sobre Nosotros</a></li>
        </ul>
    </nav>
</header>

<main>
    <div class="reset-wrapper">
        <div class="reset-form-container" id="resetFormContainer">
            <h1>Restablecer contraseña</h1>
            <form id="resetForm" style="display:none;">
                <label for="password">Nueva contraseña:</label>
                <input type="password" name="password" id="password" placeholder="Ingresa nueva contraseña" required minlength="8">
                <small class="hint">Mínimo 8 caracteres, debe incluir letras y números</small>
                <label for="confirmPassword">Repetir contraseña:</label>
                <input type="password" name="confirmPassword" id="confirmPassword" placeholder="Repite la contraseña" required minlength="8">
                <div id="errorMessage" class="error-message" style="display:none;"></div>
                <button type="submit">Restablecer</button>
            </form>
            <div id="loadingMessage" class="success-message">Validando enlace...</div>
            <div id="successMessage" class="success-message" style="display:none;"></div>
        </div>
    </div>
</main>

<!-- Footer profesional -->
<footer class="footer">
    <div class="footer-container">
        <div class="footer-logo">
            <img src="/assets/img/Alogo.png" alt="Alemandan Logo">
        </div>
        <div class="footer-links">
            <a href="/">Inicio</a>
            <a href="#features">Características</a>
            <a href="#about">Sobre Nosotros</a>
            <a href="/login">Ingresar</a>
            <a href="/terminos" target="_blank">Términos y condiciones</a>
            <a href="/privacidad" target="_blank">Política de privacidad</a>
            <a href="/faq" target="_blank">FAQ</a>
            <a href="/pqr" target="_blank">PQR</a>
            <a href="/mapa" target="_blank">Mapa de navegación</a>
        </div>
        <div class="footer-social">
            <a href="#" title="Twitter"><i class="fab fa-twitter"></i></a>
            <a href="#" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
            <a href="#" title="Instagram"><i class="fab fa-instagram"></i></a>
        </div>
        <div class="footer-contact">
            <div><i class="fas fa-phone"></i> +57 123 456 7890</div>
            <div><i class="fas fa-map-marker-alt"></i> Bogotá, Colombia</div>
        </div>
    </div>
    <div class="footer-bottom">
        <p>&copy; 2025 Alemandan POS. Todos los derechos reservados.</p>
    </div>
</footer>

<!-- JavaScript for password reset -->
<script>
    // Get token from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    const resetForm = document.getElementById('resetForm');
    const loadingMessage = document.getElementById('loadingMessage');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    const resetFormContainer = document.getElementById('resetFormContainer');

    // Validate token on page load
    if (!token) {
        showError('No se proporcionó un token de recuperación. Por favor, solicita un nuevo enlace.');
    } else {
        validateToken();
    }

    async function validateToken() {
        try {
            const response = await fetch(`/api/password-reset/validate?token=${encodeURIComponent(token)}`);
            const data = await response.json();

            if (response.ok && data.valid) {
                // Token is valid, show form
                loadingMessage.style.display = 'none';
                resetForm.style.display = 'block';
            } else {
                // Token is invalid
                showError(data.message || 'El enlace es inválido o ha expirado. Por favor, solicita un nuevo enlace de recuperación.');
            }
        } catch (error) {
            showError('Error al validar el enlace. Por favor, intenta de nuevo.');
            console.error('Error validating token:', error);
        }
    }

    // Handle form submission
    resetForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        errorMessage.style.display = 'none';

        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        // Client-side validation
        if (password.length < 8) {
            showError('La contraseña debe tener al menos 8 caracteres.');
            return;
        }

        if (!/[a-zA-Z]/.test(password)) {
            showError('La contraseña debe contener al menos una letra.');
            return;
        }

        if (!/\d/.test(password)) {
            showError('La contraseña debe contener al menos un número.');
            return;
        }

        if (password !== confirmPassword) {
            showError('Las contraseñas no coinciden.');
            return;
        }

        // Submit password reset
        try {
            const response = await fetch('/api/password-reset/reset', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    token: token,
                    password: password,
                    confirmPassword: confirmPassword
                })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                // Password reset successful
                resetForm.style.display = 'none';
                successMessage.textContent = data.message || 'La contraseña fue actualizada correctamente. Ya puedes iniciar sesión con tu nueva contraseña.';
                successMessage.style.display = 'block';
                
                // Redirect to login after 3 seconds
                setTimeout(() => {
                    window.location.href = '/login';
                }, 3000);
            } else {
                showError(data.message || 'Error al restablecer la contraseña. Por favor, intenta de nuevo.');
            }
        } catch (error) {
            showError('Error al procesar la solicitud. Por favor, intenta de nuevo.');
            console.error('Error resetting password:', error);
        }
    });

    function showError(message) {
        loadingMessage.style.display = 'none';
        resetForm.style.display = 'none';
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
    }
</script>
</body>
</html>

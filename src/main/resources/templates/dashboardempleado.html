<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Empleado | Alemandan POS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/assets/css/dashboard_empleado.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- Scoped styles only for modal/flash (no layout changes) -->
    <style>
        /* Modal backdrop (scoped, won't affect global layout) */
        #modalBackdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        #modalBackdrop.open { display:flex; }

        .modal {
            width: 520px;
            max-width: calc(100% - 32px);
            background: #fff;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.12);
            font-family: inherit;
        }

        .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
        .modal-header h3 { margin:0; font-size:1rem; color:#143dd6; }

        .modal-body { display:flex; gap:12px; flex-wrap:wrap; }
        .modal-body .left { width:120px; text-align:center; }
        .modal-body .left img { width:100px; height:100px; object-fit:cover; border-radius:8px; display:block; margin:0 auto; }
        .modal-body .right { flex:1; min-width:200px; }

        .modal-footer { display:flex; justify-content:flex-end; gap:8px; margin-top:12px; }

        .modal .btn { background:#143dd6; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
        .modal .btn.secondary { background:#f1f6ff; color:#143dd6; border:1px solid #e6eefc; }

        #flashMsg {
            position: fixed;
            top: 16px;
            right: 16px;
            background: #e6ffef;
            color: #056a3b;
            border: 1px solid #bdecc0;
            padding: 10px 14px;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.06);
            z-index: 3000;
            display: none;
        }
        #flashMsg.error { background:#ffecec; color:#8a1f1f; border-color:#f3c2c2; }

        .modal input.input {
            width:100%;
            padding:8px;
            border-radius:6px;
            border:1px solid #e6eefc;
            box-sizing:border-box;
        }

        /* --------- Styling only for "Resumen General de Ventas (Web Service)" --------- */
        .webservice-resumen {
            margin-top: 18px;
        }

        .webservice-resumen .panel {
            background: #ffffff;
            border-radius: 12px;
            padding: 14px;
            box-shadow: 0 8px 24px rgba(13,38,90,0.04);
            border: 1px solid rgba(20,61,214,0.04);
        }

        .webservice-resumen h3 {
            margin: 0 0 12px 0;
            font-size: 1rem;
            color: #143dd6;
            font-weight: 700;
        }

        .webservice-resumen ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            gap: 12px;
            align-items: stretch;
            flex-wrap: wrap;
        }

        .webservice-resumen li {
            flex: 1 1 180px;
            background: linear-gradient(180deg, #fbfdff, #f6f9ff);
            border-radius: 10px;
            padding: 12px 14px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(20,61,214,0.04);
            box-shadow: 0 6px 18px rgba(20,61,214,0.03);
            min-width: 140px;
        }

        .webservice-resumen .label {
            font-size: 0.85rem;
            color: #556680;
            text-align: center;
        }

        .webservice-resumen .value {
            font-size: 1.25rem;
            color: #0f3cb8;
            font-weight: 700;
            margin-top: 4px;
        }

        /* Make date/value stand out slightly different */
        .webservice-resumen .value.date {
            font-size: 0.98rem;
            color: #2f5aa6;
            font-weight: 600;
        }

        /* Responsive: stack vertically on narrow screens */
        @media (max-width: 680px) {
            .webservice-resumen ul { flex-direction: column; }
            .webservice-resumen li { width: 100%; }
        }
        /* --------------------------------------------------------------------------- */
    </style>
</head>
<body>
<header class="empleado-header">
    <div class="header-left">
        <img th:src="@{/assets/img/Alogo.png}" alt="Alemandan Logo" class="empleado-logo" id="logoBtn" title="Menú">
        <span class="empleado-title">EMPLEADO</span>
    </div>
    <div class="header-actions">
        <form th:action="@{/logout}" method="post" class="header-btn logout-form" style="display:inline;">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit" class="btn secondary"><i class="fas fa-sign-out-alt"></i> Cerrar sesión</button>
        </form>
    </div>
</header>

<aside class="sidebar hide" id="sidebar">
    <nav>
        <ul>
            <li><a href="/ventas/caja"><i class="fas fa-cash-register"></i> Caja</a></li>
            <li><a href="/ventas/mis-ventas"><i class="fas fa-receipt"></i> Mis ventas</a></li>
        </ul>
    </nav>
</aside>

<!-- Flash -->
<div id="flashMsg" role="alert" aria-live="polite"></div>

<main class="dashboard-main">
    <section class="empleado-profile">
        <div class="profile-info">
            <div class="profile-img-container">
                <!-- Use empleado.imagePath if available -->
                <img th:src="${empleado != null and empleado.imagePath != null ? empleado.imagePath : '/assets/img/empleado_profile.jpg'}"
                     alt="Empleado Perfil" class="profile-img" id="profilePreview">
                <span class="profile-role"><i class="fas fa-user"></i></span>
            </div>
            <div class="profile-details">
                <h2 th:text="${empleado != null ? empleado.nombre : 'Empleado'}">Empleado</h2>
                <div class="profile-contact">
                    <span><i class="fas fa-envelope"></i> <span th:text="${empleado != null ? empleado.email : 'empleado@alemandan.com'}">empleado@alemandan.com</span></span>
                </div>

                <div style="margin-top:12px;">
                    <!-- Edit button opens the modal (same UX as admin) -->
                    <button type="button" class="btn" id="openEditBtn"><i class="fas fa-user-edit"></i> Editar perfil</button>
                </div>
            </div>
        </div>

        <div class="profile-resumen">
            <div class="resumen-item">
                <span class="resumen-title">Ventas del día</span>
                <span class="resumen-value" th:text="${misVentasDia}">0</span>
            </div>
            <div class="resumen-item">
                <span class="resumen-title">Total ventas</span>
                <span class="resumen-value" th:text="${totalMisVentas}">0</span>
            </div>
        </div>

        <div class="webservice-resumen">
            <div class="panel">
                <h3>Resumen General de Ventas</h3>
                <ul>
                    <li>
                        <div class="label">Total Ventas</div>
                        <div class="value" th:text="${resumenVentas.totalVentas}">0</div>
                    </li>
                    <li>
                        <div class="label">Monto Total</div>
                        <div class="value" th:text="${resumenVentas.montoTotal}">0</div>
                    </li>
                    <li>
                        <div class="label">Fecha</div>
                        <div class="value date" th:text="${resumenVentas.fechaFormateada}">--</div>
                    </li>
                </ul>
            </div>
        </div>
    </section>
</main>

<!-- Modal (editar perfil empleado) -->
<div id="modalBackdrop" role="dialog" aria-hidden="true">
    <div class="modal" role="document" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-header">
            <h3 id="modalTitle">Editar Perfil</h3>
            <button type="button" id="closeModal" class="btn secondary" title="Cerrar">&times;</button>
        </div>

        <div class="modal-body">
            <div class="left">
                <img id="modalPreview" th:src="${empleado != null and empleado.imagePath != null ? empleado.imagePath : '/assets/img/empleado_profile.jpg'}" alt="preview">
                <div style="margin-top:8px;">
                    <button type="button" id="modalChooseBtn" class="btn secondary"><i class="fas fa-camera"></i> Elegir</button>
                </div>
                <form th:action="@{/empleado/profile/photo}" method="post" enctype="multipart/form-data" id="modalPhotoForm" style="display:none;">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <input type="file" name="photo" id="modalPhotoInput" accept="image/*"/>
                </form>
            </div>

            <div class="right">
                <form th:action="@{/empleado/profile/update}" method="post" id="modalProfileForm">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <div style="margin-bottom:8px;">
                        <label style="display:block; font-weight:600; margin-bottom:4px;">Nombre</label>
                        <input class="input" type="text" name="nombre" id="modalNombre" th:value="${empleado != null ? empleado.nombre : ''}" required>
                    </div>

                    <div style="margin-bottom:8px;">
                        <label style="display:block; font-weight:600; margin-bottom:4px;">Email</label>
                        <input class="input" type="email" name="email" id="modalEmail" th:value="${empleado != null ? empleado.email : ''}" required>
                    </div>

                    <hr style="border:none; border-top:1px dashed #eee; margin:10px 0;">

                    <div style="margin-bottom:8px;">
                        <label style="display:block; font-weight:600; margin-bottom:4px;">Contraseña actual</label>
                        <input class="input" type="password" name="currentPassword" id="modalCurrentPassword" placeholder="Contraseña actual (requerida si cambia email o contraseña)">
                    </div>

                    <div style="margin-bottom:8px;">
                        <label style="display:block; font-weight:600; margin-bottom:4px;">Nueva contraseña (opcional)</label>
                        <input class="input" type="password" name="newPassword" id="modalNewPassword" placeholder="Si quieres cambiar la contraseña">
                    </div>

                    <div class="modal-footer">
                        <button type="button" id="cancelBtn" class="btn secondary">Cancelar</button>
                        <button type="submit" class="btn"><i class="fas fa-save"></i> Guardar cambios</button>
                    </div>
                </form>

                <div style="margin-top:8px;">
                    <button type="button" id="uploadPhotoBtn" class="btn" style="display:none;">Subir foto</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sidebar toggle (same logic as empleado example) -->
<script>
    const sidebar = document.getElementById('sidebar');
    const logoBtn = document.getElementById('logoBtn');
    if (logoBtn && sidebar) {
        logoBtn.addEventListener('click', () => sidebar.classList.toggle('hide'));
    }
</script>

<!-- Modal, preview, validation and flash scripts (same behavior as admin) -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const openEditBtn = document.getElementById('openEditBtn');
        const modalBackdrop = document.getElementById('modalBackdrop');
        const closeModal = document.getElementById('closeModal');
        const cancelBtn = document.getElementById('cancelBtn');
        const modalPreview = document.getElementById('modalPreview');
        const profilePreview = document.getElementById('profilePreview');
        const modalChooseBtn = document.getElementById('modalChooseBtn');
        const modalPhotoInput = document.getElementById('modalPhotoInput');
        const modalPhotoForm = document.getElementById('modalPhotoForm');
        const modalProfileForm = document.getElementById('modalProfileForm');
        const uploadPhotoBtn = document.getElementById('uploadPhotoBtn');
        const flash = document.getElementById('flashMsg');

        function openModal() {
            if (modalBackdrop) {
                modalBackdrop.classList.add('open');
                modalBackdrop.setAttribute('aria-hidden','false');
            }
            if (modalProfileForm) {
                const firstInput = modalProfileForm.querySelector('input[name="nombre"]');
                if (firstInput) firstInput.focus();
            }
        }
        function closeModalFn() {
            if (modalBackdrop) {
                modalBackdrop.classList.remove('open');
                modalBackdrop.setAttribute('aria-hidden','true');
            }
            if (modalPhotoInput) modalPhotoInput.value = '';
            if (uploadPhotoBtn) uploadPhotoBtn.style.display = 'none';
        }

        if (openEditBtn) openEditBtn.addEventListener('click', openModal);
        if (closeModal) closeModal.addEventListener('click', closeModalFn);
        if (cancelBtn) cancelBtn.addEventListener('click', closeModalFn);

        if (modalBackdrop) {
            modalBackdrop.addEventListener('click', function(e) { if (e.target === modalBackdrop) closeModalFn(); });
        }

        if (modalChooseBtn && modalPhotoInput) {
            modalChooseBtn.addEventListener('click', () => modalPhotoInput.click());
            modalPhotoInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(evt) {
                    modalPreview.src = evt.target.result;
                    if (profilePreview) profilePreview.src = evt.target.result;
                };
                reader.readAsDataURL(file);
                uploadPhotoBtn.style.display = 'inline-block';
            });
        }

        if (uploadPhotoBtn && modalPhotoForm) {
            uploadPhotoBtn.addEventListener('click', () => modalPhotoForm.submit());
        }

        if (modalProfileForm) {
            modalProfileForm.addEventListener('submit', (e) => {
                const newPass = document.getElementById('modalNewPassword').value.trim();
                const currentPass = document.getElementById('modalCurrentPassword').value.trim();
                if (newPass && !currentPass) {
                    e.preventDefault();
                    alert('Debes ingresar la contraseña actual para cambiar la contraseña.');
                    return;
                }
            });
        }

        (function showFlashFromQuery() {
            const params = new URLSearchParams(window.location.search);
            if (!flash) return;
            if (params.get('updated') === '1') {
                flash.textContent = 'Perfil actualizado correctamente';
                flash.classList.remove('error');
                flash.style.display = 'block';
            } else if (params.get('photoUpdated') === '1') {
                flash.textContent = 'Foto de perfil actualizada';
                flash.classList.remove('error');
                flash.style.display = 'block';
            } else if (params.get('error')) {
                flash.textContent = decodeURIComponent(params.get('error'));
                flash.classList.add('error');
                flash.style.display = 'block';
            } else {
                flash.style.display = 'none';
                return;
            }
            setTimeout(() => { flash.style.display = 'none'; }, 4000);
            if (window.history && window.history.replaceState) {
                const url = new URL(window.location);
                url.searchParams.delete('updated');
                url.searchParams.delete('photoUpdated');
                url.searchParams.delete('error');
                window.history.replaceState({}, document.title, url.pathname + url.search);
            }
        })();
    });
</script>
</body>
</html>
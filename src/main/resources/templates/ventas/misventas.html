<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <title>Historial de Mis Ventas | Alemandan CRM</title>
    <link rel="stylesheet" href="/assets/css/dashboard_empleado.css">
    <link rel="stylesheet" href="/assets/css/caja_empleado_misventas.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
<header class="empleado-header">
    <div class="header-left">
        <img src="/assets/img/Alogo.png" alt="Alemandan Logo" class="empleado-logo" id="logoBtn" title="Menú">
        <span class="empleado-title">EMPLEADO</span>
    </div>
    <div class="header-actions">
        <form action="/logout" method="post" class="header-btn logout-form">
            <input type="hidden" name="_csrf" th:value="${_csrf.token}" />
            <button type="submit"><i class="fas fa-sign-out-alt"></i> Cerrar sesión</button>
        </form>
    </div>
</header>
<aside class="sidebar hide" id="sidebar">
    <nav>
        <ul>
            <li><a href="/dashboard"><i class="fas fa-home"></i> Inicio</a></li>
            <li><a href="/ventas/caja"><i class="fas fa-cash-register"></i> Caja</a></li>
            <li><a href="/ventas/mis-ventas" class="active"><i class="fas fa-receipt"></i> Mis ventas</a></li>
        </ul>
    </nav>
</aside>
<main class="ventas-main">
    <section class="ventas-panel">
        <h1><i class="fas fa-receipt"></i> Historial de Mis Ventas</h1>

        <form class="filtros-form" th:action="@{/ventas/mis-ventas}" method="get">
            <label><i class="fas fa-calendar-day"></i> Fecha inicio:</label>
            <input type="date" name="fechaInicio" th:value="${param.fechaInicio}" />
            <label><i class="fas fa-calendar-day"></i> Fecha fin:</label>
            <input type="date" name="fechaFin" th:value="${param.fechaFin}" />
            <label><i class="fas fa-box"></i> Producto:</label>
            <select name="productoId">
                <option value="">Todos</option>
                <option th:each="prod : ${productos}"
                        th:value="${prod.id}"
                        th:text="${prod.nombre}"
                        th:selected="${param.productoId != null and #strings.equals(param.productoId, prod.id.toString())}"></option>
            </select>
            <label><i class="fas fa-money-check-alt"></i> Método de pago:</label>
            <select name="metodoPago">
                <option value="">Todos</option>
                <option value="Efectivo" th:selected="${param.metodoPago == 'Efectivo'}">Efectivo</option>
                <option value="Tarjeta" th:selected="${param.metodoPago == 'Tarjeta'}">Tarjeta</option>
                <option value="Transferencia" th:selected="${param.metodoPago == 'Transferencia'}">Transferencia</option>
            </select>
            <button type="submit"><i class="fas fa-filter"></i> Filtrar</button>
        </form>

        <div class="export-btns">
            <form th:action="@{/ventas/exportar-pdf}" method="get" style="display:inline;">
                <input type="hidden" name="fechaInicio" th:value="${param.fechaInicio}" />
                <input type="hidden" name="fechaFin" th:value="${param.fechaFin}" />
                <input type="hidden" name="productoId" th:value="${param.productoId}" />
                <input type="hidden" name="metodoPago" th:value="${param.metodoPago}" />
                <button type="submit"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
            </form>
            <form th:action="@{/ventas/exportar-excel}" method="get" style="display:inline;">
                <input type="hidden" name="fechaInicio" th:value="${param.fechaInicio}" />
                <input type="hidden" name="fechaFin" th:value="${param.fechaFin}" />
                <input type="hidden" name="productoId" th:value="${param.productoId}" />
                <input type="hidden" name="metodoPago" th:value="${param.metodoPago}" />
                <button type="submit"><i class="fas fa-file-excel"></i> Exportar Excel</button>
            </form>
        </div>

        <table class="ventas-table">
            <thead>
            <tr>
                <th>Fecha</th>
                <th>Total</th>
                <th>Método de pago</th>
                <th>Productos</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="venta : ${ventas}">
                <!-- Formateo de fecha con #temporals (java.time) -->
                <td th:text="${venta.fecha != null ? #temporals.format(venta.fecha, 'dd/MM/yyyy HH:mm') : 'N/A'}"></td>

                <!-- Formateo del total usando el nombre completo del tipo en SpEL -->
                <td th:text="${venta.total != null ? T(java.lang.String).format('%.2f', venta.total.doubleValue()) : '0.00'}"></td>

                <td th:text="${venta.metodoPago}"></td>
                <td>
                    <ul>
                        <li th:each="detalle : ${venta.detalles}">
                            <span th:text="${detalle.producto.nombre}"></span>
                            (<span th:text="${detalle.cantidad}"></span>x
                            <span th:text="${detalle.precioUnitario}"></span>)
                        </li>
                    </ul>
                </td>
            </tr>
            </tbody>
        </table>
    </section>
</main>

<script>
    const sidebar = document.getElementById('sidebar');
    const logoBtn = document.getElementById('logoBtn');
    if (logoBtn) {
      logoBtn.addEventListener('click', () => {
          sidebar.classList.toggle('hide');
      });
    }
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Reporte de Ventas - Administrador | Alemandan POS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" th:href="@{/assets/css/dashboard_admin.css}">
    <link rel="stylesheet" th:href="@{/assets/css/ventas_admin.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
<header class="admin-header">
    <div class="header-left">
        <img th:src="@{/assets/img/Alogo.png}" alt="Alemandan Logo" class="admin-logo" id="logoBtn" title="Menú">
        <span class="admin-title">ADMINISTRADOR</span>
    </div>
    <div class="header-actions">
        <a href="/admin/correos-masivos" class="header-btn"><i class="fas fa-envelope"></i> Enviar correos</a>
        <form th:action="@{/logout}" method="post" class="header-btn logout-form">
            <button type="submit"><i class="fas fa-sign-out-alt"></i> Cerrar sesión</button>
        </form>
    </div>
</header>
<aside class="sidebar hide" id="sidebar">
    <nav>
        <ul>
            <li><a href="/dashboard"><i class="fas fa-home"></i> Inicio</a></li>
            <li><a href="/usuarios"><i class="fas fa-users"></i> Usuarios</a></li>
            <li><a href="/productos"><i class="fas fa-boxes"></i> Productos / Inventario</a></li>
            <li><a href="/proveedores"><i class="fas fa-truck"></i> Proveedores</a></li>
            <li><a href="/admin/ventas" class="active"><i class="fas fa-shopping-cart"></i> Ventas</a></li>
        </ul>
    </nav>
</aside>

<main class="dashboard-main">
    <section class="ventas-panel">
        <div class="ventas-header">
            <h1><i class="fas fa-chart-line"></i> Reporte de Ventas - Administrador</h1>
        </div>
        <div class="ventas-body">
            <div class="ventas-table-card">
                <form method="get" th:action="@{/admin/ventas}" class="ventas-filtros">
                    <label>Fecha inicio:</label>
                    <input type="date" name="fechaInicio" th:value="${param.fechaInicio}" />
                    <label>Fecha fin:</label>
                    <input type="date" name="fechaFin" th:value="${param.fechaFin}" />
                    <label>Empleado:</label>
                    <select name="usuarioId">
                        <option value="">Todos</option>
                        <option th:each="e : ${empleados}" th:value="${e.id}" th:text="${e.nombre}"></option>
                    </select>
                    <label>Producto:</label>
                    <select name="productoId">
                        <option value="">Todos</option>
                        <option th:each="p : ${productos}" th:value="${p.id}" th:text="${p.nombre}"></option>
                    </select>
                    <label>Método de pago:</label>
                    <select name="metodoPago">
                        <option value="">Todos</option>
                        <option value="Efectivo">Efectivo</option>
                        <option value="Tarjeta">Tarjeta</option>
                        <option value="Transferencia">Transferencia</option>
                    </select>
                    <div class="ventas-filtros-actions">
                        <button type="submit" class="ventas-filtrar-btn"><i class="fas fa-filter"></i> Filtrar</button>

                        <!-- Botón que usa el endpoint existente para exportar resumen simple a PDF (si lo mantienes) -->
                        <a th:href="@{/admin/ventas/exportar-pdf(
                                fechaInicio=${param.fechaInicio}, fechaFin=${param.fechaFin}, usuarioId=${param.usuarioId}, productoId=${param.productoId}, metodoPago=${param.metodoPago}
                            )}" class="ventas-export-btn"><i class="fas fa-file-pdf"></i> Exportar PDF (resumen)</a>

                        <!-- Botón que llama al nuevo servicio de reporte avanzado (pasa productoId para top vendedores por producto) -->
                        <a th:href="@{/ventas/reporte/pdf(
                                from=${param.fechaInicio}, to=${param.fechaFin}, productoId=${param.productoId}
                            )}" target="_blank" class="ventas-export-btn">
                            <i class="fas fa-file-pdf"></i> Generar Informe Avanzado (PDF)
                        </a>

                        <a th:href="@{/admin/ventas/exportar-excel(
                                fechaInicio=${param.fechaInicio}, fechaFin=${param.fechaFin}, usuarioId=${param.usuarioId}, productoId=${param.productoId}, metodoPago=${param.metodoPago}
                            )}" class="ventas-export-btn"><i class="fas fa-file-excel"></i> Exportar Excel</a>
                    </div>
                </form>
                <div class="ventas-table-bg">
                    <table class="ventas-table">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Fecha</th>
                            <th>Empleado</th>
                            <th>Método de pago</th>
                            <th>Total</th>
                            <th>Productos</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="v : ${ventas}">
                            <td th:text="${v.id}"></td>
                            <td th:text="${#temporals.format(v.fecha, 'yyyy-MM-dd HH:mm')}"></td>
                            <td th:text="${v.usuario != null ? v.usuario.nombre : 'N/A'}"></td>
                            <td th:text="${v.metodoPago}"></td>
                            <td th:text="${v.total}"></td>
                            <td>
                                <ul>
                                    <li th:each="d : ${v.detalles}" th:text="${d.producto.nombre + ' ( ' + d.cantidad + ' x ' + d.precioUnitario + ' )'}"></li>
                                </ul>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="ventas-chart-card">
                <h3><i class="fas fa-users"></i> Ventas por empleado</h3>
                <canvas id="chartVentasEmpleado" width="320" height="180"></canvas>
                <div style="margin-top:10px;">
                    <button id="exportChartPdf" class="chart-export-btn"><i class="fas fa-file-pdf"></i> Exportar gráfica a PDF</button>
                </div>
            </div>
        </div>
    </section>
</main>

<script th:inline="javascript">
    /*<![CDATA[*/
    // Construir los totales por empleado INYECTANDO una pequeña porción de JS por cada venta.
    // Esto evita la expresión de proyección inválida y produce un JS válido siempre.
    var empleadosMap = {};
    /*[# th:each="v : ${ventas}"]*/
    // Para cada venta se inyectan estas dos variables y se acumula en el mapa.
    var __empNombre = /*[[${v.usuario != null ? v.usuario.nombre : 'Sin nombre'}]]*/ "Sin nombre";
    var __empTotal = /*[[${v.total}]]*/ 0;
    empleadosMap[__empNombre] = (empleadosMap[__empNombre] || 0) + (__empTotal || 0);
    /*[/]*/

    var labels = Object.keys(empleadosMap);
    var data = labels.map(function(k){ return empleadosMap[k]; });

    // Crear gráfica con Chart.js
    var ctx = document.getElementById('chartVentasEmpleado').getContext('2d');
    var chartEmpleado = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Total ventas',
                data: data,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // Exportar la imagen del canvas a PDF (POST al endpoint backend que ya tienes: /admin/ventas/exportar-grafico-pdf)
    document.getElementById('exportChartPdf').onclick = function() {
        var canvas = document.getElementById('chartVentasEmpleado');
        var imgData = canvas.toDataURL('image/png');
        var fechaActual = new Date().toLocaleString();
        fetch('/admin/ventas/exportar-grafico-pdf', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ imgBase64: imgData, titulo: "Gráfica de ventas por empleado", fecha: fechaActual })
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        alert("Error al generar PDF:\n" + text);
                        throw new Error(text);
                    });
                }
                return response.blob();
            })
            .then(blob => {
                var link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = "grafico_ventas.pdf";
                link.click();
            })
            .catch(error => {
                alert("ERROR JS: " + error.message);
            });
    };
    /*]]>*/
    // Sidebar toggle
    const sidebar = document.getElementById('sidebar');
    const logoBtn = document.getElementById('logoBtn');
    logoBtn.addEventListener('click', () => {
        sidebar.classList.toggle('hide');
    });
</script>
</body>
</html>